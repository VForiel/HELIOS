# Agent Log: 2025.11.30-01 - UML Diagram Generation

## Summary
Implemented a complete UML diagram generation system for visualizing HELIOS optical simulation pipelines from scene to detector.

## Objectives
- Create a visual representation of the complete optical setup
- Display layers from left (scene) to right (cameras)
- Handle beam splitters with parallel paths displayed vertically
- Provide schematic icons for each component type

## Changes Made

### 1. Created Asset Directory and Icons
**Directory:** `src/helios/assets/`

**SVG Icons Created:**
- `scene.svg` - Star system with planets
- `telescope.svg` - Circular aperture with spider vanes
- `atmosphere.svg` - Wavy turbulence lines
- `adaptive_optics.svg` - Deformable mirror with actuator grid
- `coronagraph.svg` - Focal plane mask blocking starlight
- `beam_splitter.svg` - Diagonal mirror splitting beam
- `fiber_in.svg` - Coupling lens and fiber input
- `fiber_out.svg` - Fiber output with diverging beam
- `photonic_chip.svg` - Integrated waveguide circuit
- `camera.svg` - Detector array with pixel grid
- `interferometer.svg` - Multiple telescopes with beam combiner

All icons are 80×80px SVG with consistent styling.

### 2. Enhanced Context Class
**File:** `src/helios/core/context.py`

**New Imports:**
```python
from typing import List, Union, Optional, Any, Tuple
import matplotlib.pyplot as plt
import matplotlib.patches as patches
from matplotlib.patches import FancyBboxPatch, FancyArrowPatch
from pathlib import Path
import os
```

**New Methods:**

#### `plot_uml_diagram()`
Main public API for generating UML diagrams.

**Parameters:**
- `figsize`: Figure size (default: (16, 10))
- `layer_spacing`: Horizontal distance between layers (default: 2.0)
- `save_path`: Optional path to save figure

**Returns:** matplotlib Figure object

**Features:**
- Left-to-right layout (scene → detector)
- Automatic handling of parallel paths (beam splitters)
- Icon-based component representation
- Labeled components with names
- Arrows showing signal flow

#### `_build_layer_tree()`
Internal method to build tree structure representing layer organization.

**Returns:** List of dicts with layer metadata (position, parallel status, branch count)

#### `_count_max_parallel_paths()`
Calculates maximum number of parallel paths for vertical spacing.

#### `_draw_layer_tree()`
Main rendering engine that draws all layers and connections.

**Features:**
- Tracks active paths through beam splitters
- Calculates branch positions for parallel layers
- Draws icons and arrows with proper positioning

#### `_calculate_branch_positions()`
Computes y-positions for parallel branches after beam splitting.

#### `_draw_layer_icon()`
Renders individual layer icons with labels.

**Features:**
- Maps layer class names to SVG icons
- Uses FancyBboxPatch for rounded component boxes
- Adds text labels below components
- Handles named layers (TelescopeArray, Scene with .name attribute)

#### `_get_display_name()`
Extracts display name from layer (uses .name attribute if present, else class name).

#### `_draw_arrow()`
Draws signal flow arrows using FancyArrowPatch.

### 3. Created Test Suite
**File:** `tests/test_uml_diagram.py`

**Test Functions:**

1. **`test_simple_pipeline()`**
   - Scene → Telescope → Camera
   - Validates basic linear pipeline

2. **`test_beam_splitter_pipeline()`**
   - Scene → Telescope → BeamSplitter → [Camera1, Camera2]
   - Tests parallel path rendering

3. **`test_complex_pipeline()`**
   - Scene → Atmosphere → Telescope → AO → Coronagraph → Camera
   - Validates complex multi-layer systems

4. **`test_interferometer_pipeline()`**
   - Scene → Interferometer → Camera
   - Tests specialized multi-aperture configurations

**Output:** All tests generate PNG files for visual validation.

## Physical Coherence
- **Layout convention:** Left-to-right matches light propagation (scene → detector)
- **Parallel paths:** Vertical separation for beam-split paths is physically intuitive
- **Icon semantics:** Each icon represents the physical function of the component

## Technical Notes

### Beam Splitter Handling
The algorithm tracks "active paths" through the pipeline:
1. Start with single path (y=0.5)
2. When encountering parallel layers, calculate branch positions
3. Draw connections from all previous paths to new branches
4. Update active paths list

### Icon Rendering
Currently uses placeholder circles instead of full SVG rendering (would require `svgpath2mpl` library). The boxes and labels provide sufficient visual identification.

### Coordinate System
- **X-axis:** Layer sequence (0, spacing, 2*spacing, ...)
- **Y-axis:** Vertical position for parallel paths (0.5 = center, ±1.5 for branches)
- **Spacing:** Configurable horizontal distance between layers (default 2.0 units)

## Usage Example

```python
import helios
from astropy import units as u

# Create scene
scene = helios.Scene(distance=10*u.pc)
scene.add(helios.Star(temperature=5700*u.K, magnitude=5))

# Create telescope
telescope = helios.TelescopeArray(name="VLT")
telescope.add_collector(pupil=helios.Pupil.vlt(), position=(0, 0), size=8*u.m)

# Create beam splitter and cameras
bs = helios.BeamSplitter(cutoff=0.5)
camera1 = helios.Camera(pixels=(512, 512))
camera2 = helios.Camera(pixels=(256, 256))

# Build context
ctx = helios.Context()
ctx.add_layer(scene)
ctx.add_layer(telescope)
ctx.add_layer(bs)
ctx.add_layer([camera1, camera2])  # Parallel paths

# Generate and display diagram
fig = ctx.plot_uml_diagram()
plt.show()

# Or save to file
ctx.plot_uml_diagram(save_path='my_optical_system.png')
```

## Future Enhancements
1. **Full SVG rendering** - Use svgpath2mpl to display actual SVG icons
2. **Interactive diagrams** - Clickable components showing parameters
3. **Layout customization** - Vertical vs horizontal, custom spacing
4. **Export formats** - PDF, SVG output for publications
5. **3D visualization** - For interferometer baselines and spatial layouts

## Breaking Changes
None - this is a new feature with no impact on existing API.

## Documentation
- Added comprehensive docstrings following numpy style
- Included usage examples in Context.plot_uml_diagram()
- Test suite serves as additional documentation

## Validation
✓ All 4 test cases pass
✓ PNG outputs generated successfully
✓ Physical layout is correct (left-to-right, parallel paths)
✓ Icons properly mapped to layer types
✓ Labels display correctly

## Files Modified
- `src/helios/core/context.py` - Added UML diagram methods
- Created `src/helios/assets/` - 11 SVG icon files
- `tests/test_uml_diagram.py` - New test suite
- `tools/demo_uml_diagrams.py` - Demonstration script
- `docs/uml_diagrams.md` - Complete documentation

## Demonstration Scripts

Created `tools/demo_uml_diagrams.py` with 4 example systems:

1. **Exoplanet Detection System**
   - Scene → Atmosphere → ELT → AO → Coronagraph → Camera
   - Demonstrates complete high-contrast imaging pipeline

2. **Dual-Channel Spectrograph**
   - Scene → Telescope → BeamSplitter → [Camera1, Camera2]
   - Shows beam splitting to parallel paths

3. **Interferometer**
   - Scene → 3-telescope Interferometer → Camera
   - Illustrates multi-aperture configurations

4. **Fiber-Fed Spectrograph**
   - Scene → Telescope → FiberIn → PhotonicChip → FiberOut → Camera
   - Demonstrates integrated photonics pipeline

All demos generate both standard (150 DPI) and high-resolution (300 DPI) outputs.

## Agent: GitHub Copilot (Claude Sonnet 4.5)
## Date: 2025-11-30
