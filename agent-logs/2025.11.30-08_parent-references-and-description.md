# Agent Log: Parent References and Description Methods

**Date**: 2025-11-30  
**Topic**: Adding parent references and hierarchical description methods

## Summary

Added parent reference attributes and description methods to the Layer/Element architecture:
- Each `Layer` now has a `context` attribute referencing its parent `Context`
- Each `Element` now has a `layer` attribute referencing its parent `Layer`
- Each `Element` has a `context` shortcut (equivalent to `element.layer.context`)
- All classes (`Element`, `Layer`, `Context`) now have a `description()` method for hierarchical text output

## Files Modified

### `src/helios/core/context.py`

**Element class changes:**
- Added `layer: Optional[Layer]` attribute
- Added `context: Optional[Context]` attribute (shortcut to `layer.context`)
- Added `description(indent: int = 0) -> str` method

**Layer class changes:**
- Added `context: Optional[Context]` attribute
- Updated `add_element()` to automatically set element's `layer` and `context` references
- Added `description(indent: int = 0) -> str` method with tree visualization (├─ and └─ connectors)

**Context class changes:**
- Updated `add_layer()` to automatically set layer's `context` reference
- Updated `add_layer()` to propagate context references to all elements in the layer
- Added proper handling for layers without `elements` attribute (e.g., `Camera`)
- Added `description() -> str` method showing complete simulation pipeline

## New Features

### 1. Parent References

All components now maintain references to their parent containers:

```python
# Layer → Context
telescope = helios.TelescopeArray(name="Observatory")
ctx.add_layer(telescope)
assert telescope.context is ctx  # ✓

# Element → Layer
collector = telescope.elements[0]
assert collector.layer is telescope  # ✓

# Element → Context (shortcut)
assert collector.context is ctx  # ✓
assert collector.context == collector.layer.context  # ✓
```

### 2. Description Methods

All classes provide hierarchical text descriptions:

```python
# Element description
camera = helios.Camera(pixels=(512, 512), name="Science Camera")
print(camera.description())
# Output: Camera 'Science Camera'

# Layer description (with elements)
telescope = helios.TelescopeArray(name="VLT Array")
telescope.add_collector(pupil, position=(0, 0), size=8*u.m)
telescope.add_collector(pupil, position=(100, 0)*u.m, size=8*u.m)
print(telescope.description())
# Output:
# TelescopeArray 'VLT Array'
#   ├─ Collector 'Collector@(0.0,0.0)'
#   └─ Collector 'Collector@(100.0 m,0.0 m)'

# Context description (complete pipeline)
ctx = helios.Context()
ctx.add_layer(scene)
ctx.add_layer(telescope)
ctx.add_layer(camera)
print(ctx.description())
# Output:
# HELIOS Simulation Context
# ==================================================
# 
# Layer 1: Scene 'Target System'
#   └─ Star
# 
# Layer 2: TelescopeArray 'Observatory'
#   └─ Collector 'Collector@(0.0,0.0)'
# 
# Layer 3: Camera 'Detector'
```

### 3. Parallel Layers Support

Description methods properly handle beam splitting:

```python
ctx.add_layer(beam_splitter)
ctx.add_layer([camera1, camera2])
print(ctx.description())
# Output:
# Layer 2: BeamSplitter 'BeamSplitter'
# 
# Layer 3: [Parallel Layers]
#   Branch 1:
#     Camera 'Science'
#   Branch 2:
#     Camera 'Reference'
```

## Implementation Details

### Reference Propagation

References are set automatically when components are added:

1. **When layer is added to context** (`Context.add_layer()`):
   - Sets `layer.context = self`
   - Propagates to all elements: `element.context = self`
   - Handles both single layers and lists of parallel layers
   - Safely checks for `elements` attribute existence

2. **When element is added to layer** (`Layer.add_element()`):
   - Sets `element.layer = self`
   - Sets `element.context = self.context` (if context is available)
   - Ensures late additions still get proper references

### Tree Visualization

The description methods use Unicode box-drawing characters:
- `├─` for intermediate elements
- `└─` for last element in a group
- Indentation for hierarchical structure

## Tests Added

Created comprehensive test suite in `tests/test_context_references.py`:

- ✓ `test_layer_context_reference()` - Verifies layers have correct context references
- ✓ `test_element_layer_reference()` - Verifies elements have correct layer/context references
- ✓ `test_parallel_layers_references()` - Verifies parallel layers get references
- ✓ `test_element_description()` - Tests Element description method
- ✓ `test_layer_description()` - Tests Layer description with tree structure
- ✓ `test_context_description()` - Tests complete pipeline description
- ✓ `test_parallel_layers_description()` - Tests description with beam splitting
- ✓ `test_reference_propagation()` - Tests late element addition

All tests pass successfully. Existing tests also pass, confirming backward compatibility.

## Benefits

1. **Easier Navigation**: Components can now access parent context without passing it as parameter
2. **Debugging**: `description()` methods provide human-readable simulation structure
3. **Introspection**: Components can query their position in the hierarchy
4. **Documentation**: Auto-generated descriptions for logging and reports
5. **Validation**: Can check if components are properly attached to simulation

## Breaking Changes

None - all changes are additive and backward compatible.

## Future Enhancements

Potential uses of the new architecture:
- Automatic validation of simulation structure
- Smart parameter inheritance (e.g., wavelength, integration time)
- Context-aware plotting (access global parameters)
- Dependency injection for shared resources
- Better error messages with full component paths
